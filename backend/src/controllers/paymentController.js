const Payment = require('../models/Payment');
const Order = require('../models/Order');
const { successResponse, errorResponse } = require('../utils/responseHandler');
// Initialize Stripe only if credentials are provided
const stripe = process.env.STRIPE_SECRET_KEY ? require('stripe')(process.env.STRIPE_SECRET_KEY) : null;
const Razorpay = require('razorpay');
const crypto = require('crypto');

// Initialize Razorpay only if credentials are provided
const razorpay = process.env.RAZORPAY_KEY_ID && process.env.RAZORPAY_KEY_SECRET 
  ? new Razorpay({
      key_id: process.env.RAZORPAY_KEY_ID,
      key_secret: process.env.RAZORPAY_KEY_SECRET
    })
  : null;

// @desc    Create Stripe payment intent
// @route   POST /api/payments/stripe/create-intent
// @access  Private
exports.createStripePaymentIntent = async (req, res) => {
  try {
    const { orderId, amount } = req.body;

    const paymentIntent = await stripe.paymentIntents.create({
      amount: Math.round(amount * 100), // Convert to cents
      currency: 'usd',
      metadata: { orderId: orderId.toString(), userId: req.user._id.toString() }
    });

    // Create payment record
    const payment = await Payment.create({
      orderId,
      userId: req.user._id,
      amount,
      method: 'card',
      gateway: 'stripe',
      transactionId: paymentIntent.id,
      status: 'pending'
    });

    successResponse(res, 200, 'Payment intent created', {
      clientSecret: paymentIntent.client_secret,
      paymentId: payment._id
    });
  } catch (error) {
    errorResponse(res, 500, 'Failed to create payment intent', error.message);
  }
};

// @desc    Create Razorpay order
// @route   POST /api/payments/razorpay/create-order
// @access  Private
exports.createRazorpayOrder = async (req, res) => {
  try {
    console.log('ðŸ’³ Creating Razorpay order...');
    
    // Check if Razorpay is configured
    if (!razorpay) {
      return errorResponse(res, 503, 'Payment gateway not configured. Please contact support.');
    }
    
    const { orderId, amount } = req.body;
    
    console.log('Order ID:', orderId);
    console.log('Amount:', amount);

    if (!orderId || !amount) {
      console.error('âŒ Missing required fields');
      return errorResponse(res, 400, 'Order ID and amount are required');
    }

    const razorpayOrder = await razorpay.orders.create({
      amount: Math.round(amount * 100), // Convert to paise
      currency: 'INR',
      receipt: orderId.toString(),
      notes: {
        orderId: orderId.toString(),
        userId: req.user._id.toString()
      }
    });

    console.log('âœ… Razorpay order created:', razorpayOrder.id);

    // Create payment record
    const payment = await Payment.create({
      orderId,
      userId: req.user._id,
      amount,
      method: 'upi',
      gateway: 'razorpay',
      transactionId: razorpayOrder.id,
      status: 'pending'
    });

    console.log('ðŸ’¾ Payment record created:', payment._id);

    successResponse(res, 200, 'Razorpay order created', {
      orderId: razorpayOrder.id,
      amount: razorpayOrder.amount,
      currency: razorpayOrder.currency,
      paymentId: payment._id
    });
  } catch (error) {
    console.error('âŒ Razorpay order creation failed:', error);
    console.error('Error details:', error.error || error.message);
    errorResponse(res, 500, 'Failed to create Razorpay order', error.message);
  }
};

// @desc    Verify payment
// @route   POST /api/payments/verify
// @access  Private
exports.verifyPayment = async (req, res) => {
  try {
    console.log('ðŸ” Payment verification request received');
    console.log('Request body:', JSON.stringify(req.body, null, 2));
    
    const { paymentId, gateway, gatewayResponse } = req.body;

    if (!paymentId) {
      console.error('âŒ Missing paymentId in request');
      return errorResponse(res, 400, 'Payment ID is required');
    }

    const payment = await Payment.findById(paymentId);

    if (!payment) {
      console.error(`âŒ Payment not found for ID: ${paymentId}`);
      return errorResponse(res, 404, 'Payment not found');
    }

    console.log('ðŸ“„ Payment record found:', payment._id);

    // Verify Razorpay signature if gateway is Razorpay
    if (gateway === 'razorpay' && gatewayResponse) {
      // Check if Razorpay is configured
      if (!process.env.RAZORPAY_KEY_SECRET) {
        return errorResponse(res, 503, 'Payment gateway not configured. Please contact support.');
      }
      
      const { razorpay_order_id, razorpay_payment_id, razorpay_signature } = gatewayResponse;
      
      console.log('ðŸ” Verifying Razorpay signature...');
      console.log('Order ID:', razorpay_order_id);
      console.log('Payment ID:', razorpay_payment_id);
      
      const body = razorpay_order_id + '|' + razorpay_payment_id;
      const expectedSignature = crypto
        .createHmac('sha256', process.env.RAZORPAY_KEY_SECRET)
        .update(body.toString())
        .digest('hex');

      if (expectedSignature !== razorpay_signature) {
        console.error('âŒ Razorpay signature verification failed');
        console.error('Expected:', expectedSignature);
        console.error('Received:', razorpay_signature);
        return errorResponse(res, 400, 'Invalid payment signature');
      }
      
      console.log('âœ… Razorpay signature verified successfully');
    }

    // Update payment status
    payment.status = 'success';
    payment.gatewayResponse = gatewayResponse;
    await payment.save();
    console.log('ðŸ’¾ Payment status updated to success');

    // Update order payment status
    const order = await Order.findById(payment.orderId);
    if (order) {
      order.paymentStatus = 'completed';
      // Don't auto-confirm - restaurant needs to confirm manually
      // Order stays in 'pending' status until restaurant confirms
      await order.save();
      console.log(`âœ… Order ${order._id} payment completed. Status: ${order.status} (waiting for restaurant confirmation)`);
    } else {
      console.warn('âš ï¸ Order not found for payment');
    }

    successResponse(res, 200, 'Payment verified successfully', { payment, order });
  } catch (error) {
    console.error('âŒ Payment verification error:', error);
    console.error('Error stack:', error.stack);
    errorResponse(res, 500, 'Payment verification failed', error.message);
  }
};

// @desc    Handle payment failure
// @route   POST /api/payments/:id/fail
// @access  Private
exports.handlePaymentFailure = async (req, res) => {
  try {
    const payment = await Payment.findById(req.params.id);

    if (!payment) {
      return errorResponse(res, 404, 'Payment not found');
    }

    payment.status = 'failed';
    payment.gatewayResponse = req.body.error;
    await payment.save();

    // Optionally cancel the order
    const order = await Order.findById(payment.orderId);
    if (order && order.status === 'pending') {
      order.status = 'cancelled';
      order.cancellationReason = 'Payment failed';
      await order.save();
    }

    successResponse(res, 200, 'Payment failure recorded', { payment });
  } catch (error) {
    errorResponse(res, 500, 'Failed to handle payment failure', error.message);
  }
};

// @desc    Get payment by order ID
// @route   GET /api/payments/order/:orderId
// @access  Private
exports.getPaymentByOrderId = async (req, res) => {
  try {
    const payment = await Payment.findOne({ orderId: req.params.orderId });

    if (!payment) {
      return errorResponse(res, 404, 'Payment not found');
    }

    successResponse(res, 200, 'Payment retrieved successfully', { payment });
  } catch (error) {
    errorResponse(res, 500, 'Failed to get payment', error.message);
  }
};